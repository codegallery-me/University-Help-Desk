<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ticket Details - UniSupport</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body id="body-root">

    <div id="navbar-placeholder"></div>

    <div class="container py-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="dashboard.html" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-arrow-left me-1"></i> Back
            </a>
            <button id="theme-toggle" class="btn btn-outline-dark bg-white" title="Toggle dark mode">
                <span id="theme-icon" class="fa-solid fa-moon"></span>
            </button>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                
                <div class="modern-card p-4 p-md-5 mb-4">
                    
                    <div class="text-center mb-4 border-bottom pb-4">
                        <h2 id="ticket-title" class="fw-bold mb-3">Loading Ticket...</h2>
                        
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <span class="badge bg-secondary fs-6">
                                <i class="fa-solid fa-tag me-1"></i> <span id="ticket-category">...</span>
                            </span>
                            <span id="ticket-status" class="badge fs-6">...</span>
                        </div>
                        
                        <div class="mt-3 text-muted small">
                            <i class="fa-solid fa-user me-1"></i> <span id="ticket-owner">...</span> 
                            <span class="mx-2">â€¢</span>
                            <i class="fa-regular fa-calendar me-1"></i> <span id="ticket-date">...</span>
                        </div>
                    </div>

                    <div class="mb-5">
                        <h5 class="fw-bold text-primary mb-3"><i class="fa-solid fa-align-left me-2"></i>Description</h5>
                        <div class="p-3 bg-light bg-opacity-10 border rounded">
                            <p id="ticket-description" class="mb-0" style="white-space: pre-wrap;">Loading description...</p>
                        </div>
                    </div>

                    <div>
                        <h5 class="fw-bold text-primary mb-3"><i class="fa-solid fa-comments me-2"></i>Comments</h5>
                        
                        <div id="comments-container" class="mb-4 d-flex flex-column gap-3">
                            </div>

                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <label class="fw-bold mb-2">Add a reply</label>
                                <textarea id="comment-text" class="form-control mb-3" rows="3" placeholder="Type your response here..."></textarea>
                                <div class="text-end">
                                    <button id="post-comment-btn" class="btn btn-primary px-4">
                                        <i class="fa-solid fa-paper-plane me-2"></i> Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/navbar.js"></script>
    <script type="module">
        import { loadNavbar } from './js/navbar.js';
        if(typeof loadNavbar === 'function') loadNavbar();
    </script>
    
    <script>
        const bodyRoot = document.getElementById('body-root');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function setTheme(dark) {
            if (dark) {
                bodyRoot.classList.add('dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                bodyRoot.classList.remove('dark-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }
        if(themeToggle) {
            themeToggle.addEventListener('click', () => setTheme(!bodyRoot.classList.contains('dark-theme')));
        }
        setTheme(localStorage.getItem('theme') === 'dark');
    </script>

    <script type="module">
        import { getTicketById, getComments, addComment } from './js/api.js';

        const params = new URLSearchParams(window.location.search);
        const ticketId = params.get("id");

        if(!ticketId){
            window.location.href = "dashboard.html";
        }

        const token = localStorage.getItem("access_token");
        if(!token){
            window.location.href="login.html";
        }

        // --- Fetch Ticket Details ---
        fetch(`https://university-help-desk.onrender.com/tickets/${ticketId}`, {
            method:"GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        })
        .then(res => {
            if(!res.ok) throw new Error("Failed to fetch ticket");
            return res.json();
        })
        .then(ticket => {
            document.getElementById("ticket-title").innerText = ticket.title;
            document.getElementById("ticket-category").innerText = ticket.category.toUpperCase();
            document.getElementById("ticket-description").innerText = ticket.description;
            document.getElementById("ticket-owner").innerText = ticket.owner_name;

            const date = new Date(ticket.created_at);
            document.getElementById("ticket-date").innerText = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

            const statusEl = document.getElementById("ticket-status");
            let statusText = ticket.status.replace("_", " ").toUpperCase();
            statusEl.innerText = statusText;

            // Remove old classes and add new ones
            statusEl.className = "badge fs-6"; 
            if(ticket.status === "open") statusEl.classList.add("bg-warning", "text-dark");
            else if(ticket.status === "in_progress") statusEl.classList.add("bg-info", "text-dark");
            else if(ticket.status === "resolved") statusEl.classList.add("bg-success");
        })
        .catch(err => {
            console.error(err);
            document.getElementById("ticket-title").innerText = "Error loading ticket.";
        });

        // --- Comments Logic ---
        async function loadComments() {
            try {
                const comments = await getComments(ticketId);
                const container = document.getElementById("comments-container");
                container.innerHTML = "";

                if (!comments || comments.length === 0) {
                    container.innerHTML = "<div class='text-center text-muted my-3'>No comments yet.</div>";
                    return;
                }

                comments.forEach(c => {
                    const div = document.createElement("div");
                    // Using Bootstrap border + padding for comments
                    div.className = "p-3 border rounded mb-2 bg-body"; 
                    
                    const dateStr = new Date(c.created_at).toLocaleString();

                    div.innerHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold text-primary small">${c.owner_name}</span>
                            <small class="text-muted" style="font-size: 0.8rem;">${dateStr}</small>
                        </div>
                        <p class="mb-0 text-break">${c.text}</p>
                    `;
                    container.appendChild(div);
                });
            } catch (err) {
                console.error("Error loading comments:", err);
            }
        }

        document.getElementById("post-comment-btn").onclick = async () => {
            const input = document.getElementById("comment-text");
            const btn = document.getElementById("post-comment-btn");
            const text = input.value.trim();

            if (!text) return;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                
                await addComment(ticketId, text);
                input.value = "";
                await loadComments();
            } catch (err) {
                alert("Could not post comment.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i> Post';
            }
        };

        // Initial Load
        loadComments();

    </script>
</body>
</html>