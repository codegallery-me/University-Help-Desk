<!DOCTYPE html>  <html lang="en">  
    <head>  
        <meta charset="UTF-8">  
        <title>Ticket Details - UniSupport</title>  
        <meta name ="viewport" content="width=device-width, initial-scale=1.0">  
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">  
        <link rel="stylesheet" href="css/styles.css">  
    </head>  
    
    <body class="bg-light">  
      
    <div id="navbar-placeholder"></div>  

    <nav class="navbar navbar-dark bg-primary px-4">
        <span class="navbar-brand">UniSupport</span>
        <button class="btn btn-light btn-sm" id="logoutBtn">Logout</button>
    </nav>

    <div class="container mt-4 ">

        <h3 id="ticket-title" class="mb-3 text-center">Loading...</h3> 

    <div class="d-flex justify-content-center ">        

        <div class="card shadow" style="width:100%;max-width:1000px">  
            <div class="card-body">   

                <p class="mb-1">
                    <strong>Category: </strong>
                    <span id="ticket-category">Loading...</span>
                </p>

                <p class="mb-1">
                    <strong>Status: </strong>
                    <span id="ticket-status" class="badge">Loading...</span>
                </p>

                <p class="text-muted">
                    <strong>Created by: </strong>
                    <span id="ticket-owner">Loading...</span>  on
                    <span id="ticket-date">Loading...</span>
                </p>


                <h5><b>Description:</b></h5>
                <p id="ticket-description" class="text-muted">  Loading description...</p>

                <hr>

                <h5><b>Comments</b></h5>

                <!-- Comment -->
                <div id="comments-container"></div>

                <!-- Add Comment -->
                <textarea id="comment-text" rows="3" placeholder="Add comment..."></textarea>
                <button id="post-comment-btn" class="btn-primary">Post Comment</button>

            </div>  
        </div>  
    </div>  
</div>

    <script type="module">  
        import { loadNavbar } from './js/navbar.js';  
        import { getTicketById, getComments, addComment } from './js/api.js';

        loadNavbar();  

        const params= new URLSearchParams(window.location.search);  
        const ticketId=params.get("id"); 

        if(!ticketId){  
            alert("No ticket ID provided");  
            window.location.href = "dashboard.html";  
        }  

        const token=localStorage.getItem("access_token");  

        if(!token){  
            alert("You are not logged in");  
            window.location.href="login.html";  
        }  

        fetch(`https://university-help-desk.onrender.com/tickets/${ticketId}`,{  
            method:"GET",  
            headers:{  
                "Authorization":`Bearer ${token}`,  
                "content-Type":"application/json"  
            }  
        })  

        .then(res=>{  
            if(!res.ok){  
                throw new Error("Failed to fetch ticket");  
            }  
            return res.json();  
        })  

        .then(ticket=>{  
            document.getElementById("ticket-title").innerText=ticket.title; 
            document.getElementById("ticket-category").innerText=ticket.category; 
            document.getElementById("ticket-description").innerText=ticket.description;  
            document.getElementById("ticket-owner").innerText=ticket.owner_name;

            const date=new Date(ticket.created_at);
            document.getElementById("ticket-date").innerText=date.toISOString().split("T")[0];


            const statusEl=document.getElementById("ticket-status");  

            let statusText = ticket.status.replace("_", " ").toUpperCase();  
            statusEl.innerText = statusText;  

            if(ticket.status==="open") {  
                statusEl.classList.add("bg-warning");  
            }  
            else if(ticket.status==="in_progress"){  
                statusEl.classList.add("bg-info");  
            }   
            else if(ticket.status==="resolved"){  
                statusEl.classList.add("bg-success");  
            }  
        })  

        .catch(err=>{  
            console.error(err);  
            alert("Error loading ticket details");  
        });  

        document.getElementById("logoutBtn").onclick = () => {
            localStorage.clear();
            window.location.href = "login.html";
        };


        // Load Comments
        async function loadComments() {
            try {
                const comments = await getComments(ticketId);
                const container = document.getElementById("comments-container");
                container.innerHTML = "";

                if (!comments || comments.length === 0) {
                    container.innerHTML = "<p class='text-muted'>No comments yet.</p>";
                    return;
                }

                comments.forEach(c => {
                    const div = document.createElement("div");
                    
                    div.className = "comment-box border rounded p-2 mb-2"; 

                    div.innerHTML = `<div class="comment-header">

                        <span class="comment-author">${c.owner_name}</span>
                        <span class="comment-time">${new Date(c.created_at).toISOString().split("T")[0]}</span>
                        
                        </div>
                        <p class="mb-1">${c.text}</p>
                    `;
                    container.appendChild(div);
                });
            } catch (err) {
                console.error("Error loading comments:", err);
            }
        }
    


        // Post Comment 
        document.getElementById("post-comment-btn").onclick = async () => {
            const input = document.getElementById("comment-text");
            const text = input.value.trim();

            if (!text) return alert("Comment cannot be empty");

            try {
                await addComment(ticketId, text);
                input.value = "";

                loadComments(); 

            } catch (err) {
                alert("Could not post comment.");
            }
        };

        loadComments();


    </script>  
</body>