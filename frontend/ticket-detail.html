<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ticket Details - UniSupport</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body id="body-root">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fa-solid fa-graduation-cap me-2"></i>UniSupport</a>
            <div class="d-flex gap-2 ms-auto">
                 <a href="dashboard.html" class="btn btn-sm btn-outline-light">Dashboard</a>
                 <button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="dashboard.html" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-arrow-left me-1"></i> Back to Dashboard
            </a>
            <button id="theme-toggle" class="btn btn-outline-dark bg-white" title="Toggle dark mode">
                <span id="theme-icon" class="fa-solid fa-moon"></span>
            </button>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-4 p-md-5">
                        
                        <div class="text-center mb-4 border-bottom pb-4">
                            <h2 id="ticket-title" class="fw-bold mb-3">Loading Ticket...</h2>
                            
                            <div class="d-flex justify-content-center gap-3 flex-wrap align-items-center">
                                <span class="badge bg-secondary fs-6">
                                    <i class="fa-solid fa-tag me-1"></i> <span id="ticket-category">...</span>
                                </span>
                                <span id="ticket-status" class="badge fs-6">...</span>
                            </div>
                            
                            <div class="mt-3 text-muted small">
                                <i class="fa-solid fa-user me-1"></i> <span id="ticket-owner">...</span> 
                                <span class="mx-2">â€¢</span>
                                <i class="fa-regular fa-calendar me-1"></i> <span id="ticket-date">...</span>
                            </div>
                        </div>

                        <div class="mb-5">
                            <h5 class="fw-bold text-primary mb-3"><i class="fa-solid fa-align-left me-2"></i>Description</h5>
                            <div class="p-4 bg-light bg-opacity-50 border rounded">
                                <p id="ticket-description" class="mb-0 text-dark" style="white-space: pre-wrap; line-height: 1.6;">Loading description...</p>
                            </div>
                        </div>

                        <hr class="my-5">

                        <h5 class="fw-bold mb-3"><i class="fa-regular fa-comments me-2"></i>Discussion</h5>
                        
                        <div id="comments-container" class="mb-4">
                            </div>

                        <div id="admin-tools" class="d-none mb-2 p-2 bg-warning bg-opacity-10 rounded border border-warning">
                            <label class="small fw-bold text-muted mb-1">Admin Quick Tools:</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white"><i class="fa-solid fa-bolt text-warning"></i></span>
                                <select id="canned-select" class="form-select">
                                    <option value="" selected>Choose a Quick Reply...</option>
                                    </select>
                                <button class="btn btn-outline-secondary bg-white" type="button" onclick="insertCannedResponse()">Insert</button>
                                <button class="btn btn-outline-primary bg-white" type="button" onclick="openCreateCannedModal()">
                                    <i class="fa-solid fa-plus"></i> New
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <textarea id="comment-input" class="form-control mb-3 shadow-sm" rows="4" placeholder="Type your reply here..."></textarea>
                            <div class="d-flex justify-content-end">
                                <button id="post-comment-btn" class="btn btn-primary fw-bold px-4">
                                    <i class="fa-solid fa-paper-plane me-2"></i>Post Reply
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="createCannedModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">New Quick Reply</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title (Internal Name)</label>
                        <input type="text" id="canned-title" class="form-control" placeholder="e.g. Wi-Fi Fix">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Response Content</label>
                        <textarea id="canned-content" class="form-control" rows="5" placeholder="The full message to insert..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="saveCannedResponse()">Save Response</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // CONFIGURATION
        const API_URL = "http://localhost:8000"; // Ensure this matches your backend port
        const params = new URLSearchParams(window.location.search);
        const ticketId = params.get("id");
        const token = localStorage.getItem("access_token");

        // Auth Check
        if(!token) window.location.href="login.html";
        if(!ticketId) window.location.href = "dashboard.html";

        // LOAD TICKET DETAILS
        async function loadTicket() {
            try {
                const res = await fetch(`${API_URL}/tickets/${ticketId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if(!res.ok) throw new Error("Ticket not found");
                
                const ticket = await res.json();
                
                // Update UI
                document.getElementById("ticket-title").innerText = ticket.title;
                document.getElementById("ticket-category").innerText = ticket.category || "General";
                document.getElementById("ticket-description").innerText = ticket.description;
                document.getElementById("ticket-owner").innerText = ticket.owner_name;
                document.getElementById("ticket-date").innerText = new Date(ticket.created_at).toLocaleString();

                // Status Badge
                const statusEl = document.getElementById("ticket-status");
                statusEl.innerText = ticket.status.replace("_", " ").toUpperCase();
                
                statusEl.className = "badge fs-6 border"; 
                if(ticket.status === "open") statusEl.classList.add("bg-warning", "text-dark", "border-warning");
                else if(ticket.status === "in_progress") statusEl.classList.add("bg-info", "text-dark", "border-info");
                else if(ticket.status === "resolved") statusEl.classList.add("bg-success", "border-success");

            } catch (err) {
                console.error(err);
                alert("Error loading ticket details.");
                window.location.href = "dashboard.html";
            }
        }

        // LOAD COMMENTS
        async function loadComments() {
            try {
                const res = await fetch(`${API_URL}/tickets/${ticketId}/comments`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const comments = await res.json();
                const container = document.getElementById("comments-container");
                container.innerHTML = "";

                if (!comments || comments.length === 0) {
                    container.innerHTML = "<div class='text-center text-muted fst-italic py-3'>No comments yet. Start the conversation!</div>";
                    return;
                }

                comments.forEach(c => {
                    const dateStr = new Date(c.created_at).toLocaleString();
                    // Identify if comment is by current user
                    // (You might need to store user_id in localStorage on login to highlight properly, skipping for now)
                    
                    const html = `
                        <div class="card mb-3 border-0 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold text-primary">${c.owner_name}</span>
                                    <small class="text-muted">${dateStr}</small>
                                </div>
                                <p class="mb-0 text-dark" style="white-space: pre-wrap;">${c.text}</p>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            } catch (err) {
                console.error("Error loading comments:", err);
            }
        }

        // POST COMMENT
        document.getElementById("post-comment-btn").onclick = async () => {
            const input = document.getElementById("comment-input");
            const btn = document.getElementById("post-comment-btn");
            const text = input.value.trim();

            if (!text) return;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Sending...';
                
                const res = await fetch(`${API_URL}/tickets/${ticketId}/comments`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ text: text })
                });

                if(!res.ok) throw new Error("Failed");

                input.value = "";
                await loadComments(); // Reload list

            } catch (err) {
                alert("Could not post comment.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i> Post Reply';
            }
        };

        // ADMIN TOOLS (CANNED RESPONSES)
        
        async function initAdminTools() {
            const role = localStorage.getItem('user_role');
            if (role === 'admin') {
                document.getElementById('admin-tools').classList.remove('d-none');
                loadCannedResponses();
            }
        }

        async function loadCannedResponses() {
            try {
                const res = await fetch(`${API_URL}/admin/canned-responses`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if(!res.ok) return; // Might fail if not admin
                
                const responses = await res.json();
                const select = document.getElementById('canned-select');
                select.innerHTML = '<option value="">Choose a Quick Reply...</option>';
                
                responses.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r._id;
                    option.textContent = r.title;
                    option.dataset.content = r.content; 
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Failed to load canned responses");
            }
        }

        // Global function for HTML onclick
        window.insertCannedResponse = () => {
            const select = document.getElementById('canned-select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const commentBox = document.getElementById('comment-input');
                const textToInsert = selectedOption.dataset.content;
                // Add newline if box is not empty
                commentBox.value += (commentBox.value ? "\n\n" : "") + textToInsert;
            }
        };

        window.openCreateCannedModal = () => {
            new bootstrap.Modal(document.getElementById('createCannedModal')).show();
        };

        window.saveCannedResponse = async () => {
            const title = document.getElementById('canned-title').value;
            const content = document.getElementById('canned-content').value;

            if(!title || !content) {
                alert("Please fill in both fields");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/admin/canned-responses`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ title, content })
                });

                if(!res.ok) throw new Error("Failed");

                alert("Response Saved!");
                location.reload(); 
            } catch(e) {
                alert("Error saving response");
            }
        };


        // THEME & LOGOUT LOGIC
        const bodyRoot = document.getElementById('body-root');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function setTheme(dark) {
            if (dark) {
                bodyRoot.classList.add('dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                bodyRoot.classList.remove('dark-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }
        if(themeToggle) {
            themeToggle.addEventListener('click', () => setTheme(!bodyRoot.classList.contains('dark-theme')));
        }
        setTheme(localStorage.getItem('theme') === 'dark');

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "login.html";
        });

        loadTicket();
        loadComments();
        initAdminTools();

    </script>
</body>
</html>